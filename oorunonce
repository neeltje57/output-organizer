# ==============================
oo_runonce_default_minutes=1440
# ==============================
echo "* Start oorunonce"
if [[ -z "$oo_runonce_minutes" ]]
then
  oo_runonce_minutes=$oo_runonce_default_minutes
  echo "oo_runonce_minutes is not overridden, default value will be used: ""$oo_runonce_minutes"
else
  # Check if it is an integer, if not (user made a typo) use default value.
  s2u_re='^[0-9]+$'
  if ! [[ $oo_runonce_minutes =~ $oo_re ]] ; then
    oo_runonce_minutes=$oo_runonce_default_minutes
    echo "oo_runonce_minutes is not numeric, default value will be used: ""$oo_runonce_minutes"
  else
    echo "oo_runonce_minutes is overridden, new value will be used: ""$oo_runonce_minutes"
  fi
fi

s2u_runonce_registrydir=/var/s2urunonce
if [[ -d "$oo_runonce_registrydir" ]]; then 
  oo_runonce_user=$(whoami)
  mkdir -p $oo_runonce_registrydir/$oo_runonce_user
  oo_runonce_registryfile=$oo_runonce_registrydir/$oo_runonce_user/$(basename $0)
  echo "oo_runonce_registryfile is: ""$oo_runonce_registryfile"
else
  echo "Registry $oo_runonce_registrydir doesnot exist, program aborts"
  echo "* End oorunonce"
  exit 1
fi
if [[ -f $oo_runonce_registryfile ]]
then
  if  (( (`date +%s` - `date -r "$oo_runonce_registryfile" +%s`) > ($oo_runonce_minutes*60) )); then
    echo "$oo_runonce_registryfile"" expired, processing continues"
    touch "$oo_runonce_registryfile"
  else
    echo "$oo_runonce_registryfile"" not yet expired, processing not allowed, script stops"
    echo "* End oorunonce"
    exit 0
  fi
else
  echo "Registryfile ""$oo_runonce_registryfile"" not found,will be initialized, processing continues"
  touch "$oo_runonce_registryfile"
fi
echo "* End oorunonce"
